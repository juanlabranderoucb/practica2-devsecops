name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  devsecops:
    runs-on: ubuntu-latest
    
    steps:
    # =========================
    # 1. CHECKOUT
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarQube

    # =========================
    # 2. SETUP ENVIRONMENTS
    # =========================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: |
          backend/users-service/package-lock.json
          backend/academic-service/package-lock.json
          backend/api-gateway/package-lock.json
          frontend/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # =========================
    # 3. INSTALACIÃ“N REPRODUCIBLE
    # =========================
    - name: ğŸ“¦ Install users-service dependencies
      run: |
        cd backend/users-service
        npm ci --prefer-offline --no-audit
        
    - name: ğŸ“¦ Install academic-service dependencies
      run: |
        cd backend/academic-service
        npm ci --prefer-offline --no-audit

    - name: ğŸ“¦ Install api-gateway dependencies
      run: |
        cd backend/api-gateway
        npm ci --prefer-offline --no-audit

    - name: ğŸ“¦ Install frontend dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit

    # =========================
    # 4. ANÃLISIS DE CALIDAD (ESLINT)
    # =========================
    - name: ğŸ” ESLint - users-service
      run: |
        cd backend/users-service
        npx eslint src/ --max-warnings=0 || true
      
    - name: ğŸ” ESLint - academic-service
      run: |
        cd backend/academic-service
        npx eslint src/ --max-warnings=0 || true

    - name: ğŸ” ESLint - api-gateway
      run: |
        cd backend/api-gateway
        npx eslint src/ --max-warnings=0 || true

    - name: ğŸ” ESLint - frontend
      run: |
        cd frontend
        npm run lint

    # =========================
    # 5. TESTING AUTOMATIZADO
    # =========================
    - name: ğŸ§ª Test users-service
      run: |
        cd backend/users-service
        npm test -- --coverage --passWithNoTests
        
    - name: ğŸ§ª Test academic-service
      run: |
        cd backend/academic-service
        npm test -- --coverage --passWithNoTests

    - name: ğŸ§ª Test api-gateway
      run: |
        cd backend/api-gateway
        npm test -- --coverage --passWithNoTests

    - name: ğŸ§ª Test frontend
      run: |
        cd frontend
        npm test -- --coverage --passWithNoTests

    # =========================
    # 6. SAST - SEMGREP (AnÃ¡lisis rÃ¡pido)
    # =========================
    - name: Install Semgrep
      run: |
        pip install --no-cache-dir --disable-pip-version-check semgrep

    - name: ğŸ”’ Semgrep SAST - users-service
      run: |
        cd backend/users-service
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"
        
    - name: ğŸ”’ Semgrep SAST - academic-service
      run: |
        cd backend/academic-service
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"

    - name: ğŸ”’ Semgrep SAST - api-gateway
      run: |
        cd backend/api-gateway
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"

    - name: ğŸ”’ Semgrep SAST - frontend
      run: |
        cd frontend
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"

    # =========================
    # 7. SAST - SONARQUBE (AnÃ¡lisis profundo)
    # =========================
    - name: ğŸ”’ SonarQube Scan
      continue-on-error: true
      uses: sonarsource/sonarqube-scan-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=juanlabranderoucb_practica2-devsecops
          -Dsonar.projectName="DevSecOps Microservices"
          -Dsonar.organization=juanlabranderoucb

    - name: ğŸ”’ SonarQube Quality Gate check
      if: always()
      continue-on-error: true
      uses: sonarsource/sonarqube-quality-gate-action@master
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # =========================
    # 8. SCA - ANÃLISIS DE DEPENDENCIAS
    # =========================
    - name: ğŸ›¡ï¸ npm audit - users-service
      run: |
        cd backend/users-service
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    - name: ğŸ›¡ï¸ npm audit - academic-service
      run: |
        cd backend/academic-service
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    - name: ğŸ›¡ï¸ npm audit - api-gateway
      run: |
        cd backend/api-gateway
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    - name: ğŸ›¡ï¸ npm audit - frontend
      run: |
        cd frontend
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    # =========================
    # 9. CREAR VARIABLES DE ENTORNO
    # =========================
    - name: Create .env files for services
      run: |
        # Backend services
        cp backend/users-service/.env.example backend/users-service/.env
        cp backend/academic-service/.env.example backend/academic-service/.env
        cp backend/api-gateway/.env.example backend/api-gateway/.env
        
        # Frontend
        cp frontend/.env.example frontend/.env
        echo "VITE_API_URL=http://localhost:3000" >> frontend/.env

    # =========================
    # 10. BUILD DE CONTENEDORES
    # =========================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ‹ Build Docker image - users-service
      run: |
        docker build \
          -t users-service:latest \
          -t users-service:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./backend/users-service

    - name: ğŸ‹ Build Docker image - academic-service
      run: |
        docker build \
          -t academic-service:latest \
          -t academic-service:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./backend/academic-service

    - name: ğŸ‹ Build Docker image - api-gateway
      run: |
        docker build \
          -t api-gateway:latest \
          -t api-gateway:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./backend/api-gateway

    - name: ğŸ‹ Build Docker image - frontend
      run: |
        docker build \
          -t frontend:latest \
          -t frontend:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./frontend

    # =========================
    # 11. SEGURIDAD DE CONTENEDORES - TRIVY
    # =========================
    - name: ğŸ” Trivy scan - users-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'users-service:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    - name: ğŸ” Trivy scan - academic-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'academic-service:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    - name: ğŸ” Trivy scan - api-gateway
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'api-gateway:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    - name: ğŸ” Trivy scan - frontend
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'frontend:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    # =========================
    # 12. SMOKE TESTS
    # =========================
    - name: ğŸš€ Start services with docker-compose
      run: |
        cd backend
        docker compose up -d
        sleep 20

    - name: ğŸ§ª Smoke test - users-service
      run: |
        curl -f http://localhost:3001/health || exit 1
        echo "âœ… Users service is healthy"

    - name: ğŸ§ª Smoke test - academic-service  
      run: |
        curl -f http://localhost:3002/health || exit 1
        echo "âœ… Academic service is healthy"

    - name: ğŸ§ª Smoke test - api-gateway
      run: |
        curl -f http://localhost:3000/health || exit 1
        echo "âœ… API Gateway is healthy"

    - name: ğŸ§ª Smoke test - frontend
      run: |
        curl -f http://localhost:5173 || exit 1
        echo "âœ… Frontend is healthy"

    # =========================
    # 13. CLEANUP
    # =========================
    - name: ğŸ§¹ Shutdown services
      if: always()
      run: |
        cd backend
        docker compose down -v || true
        docker system prune -f || true

    # =========================
    # 14. REPORTE FINAL
    # =========================
    - name: ğŸ“Š Pipeline Summary
      if: always()
      run: |
        echo "================================"
        echo "ğŸ‰ PIPELINE DEVSECOPS COMPLETO"
        echo "================================"
        echo "âœ… InstalaciÃ³n reproducible"
        echo "âœ… AnÃ¡lisis de calidad (ESLint)"
        echo "âœ… Testing automatizado"
        echo "âœ… SAST (Semgrep + SonarQube)"
        echo "âœ… SCA (npm audit)"
        echo "âœ… Build de contenedores"
        echo "âœ… Seguridad contenedores (Trivy)"
        echo "âœ… Smoke tests"
        echo "================================"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "================================"