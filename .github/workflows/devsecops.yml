name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  devsecops:
    runs-on: ubuntu-latest
    
    steps:
    # =========================
    # 1. CHECKOUT
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarQube

    # =========================
    # 2. SETUP ENVIRONMENTS
    # =========================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: |
          backend/users-service/package-lock.json
          backend/academic-service/package-lock.json
          backend/api-gateway/package-lock.json
          frontend/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # =========================
    # 3. INSTALACI√ìN REPRODUCIBLE
    # =========================
    - name: üì¶ Install users-service dependencies
      run: |
        cd backend/users-service
        npm ci --prefer-offline --no-audit
        
    - name: üì¶ Install academic-service dependencies
      run: |
        cd backend/academic-service
        npm ci --prefer-offline --no-audit

    - name: üì¶ Install api-gateway dependencies
      run: |
        cd backend/api-gateway
        npm ci --prefer-offline --no-audit

    - name: üì¶ Install frontend dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit

    # =========================
    # 4. AN√ÅLISIS DE CALIDAD (ESLINT)
    # =========================
    - name: üîç ESLint - users-service
      run: |
        cd backend/users-service
        npx eslint src/ --max-warnings=0 || true
      
    - name: üîç ESLint - academic-service
      run: |
        cd backend/academic-service
        npx eslint src/ --max-warnings=0 || true

    - name: üîç ESLint - api-gateway
      run: |
        cd backend/api-gateway
        npx eslint src/ --max-warnings=0 || true

    - name: üîç ESLint - frontend
      run: |
        cd frontend
        npm run lint

    # =========================
    # 5. TESTING AUTOMATIZADO
    # =========================
    - name: üß™ Test users-service
      run: |
        cd backend/users-service
        npm test -- --coverage --passWithNoTests
        
    - name: üß™ Test academic-service
      run: |
        cd backend/academic-service
        npm test -- --coverage --passWithNoTests

    - name: üß™ Test api-gateway
      run: |
        cd backend/api-gateway
        npm test -- --coverage --passWithNoTests

    - name: üß™ Test frontend
      run: |
        cd frontend
        npm test -- --coverage --passWithNoTests

    # =========================
    # 6. SAST - SEMGREP (An√°lisis r√°pido)
    # =========================
    - name: Install Semgrep
      run: |
        pip install --no-cache-dir --disable-pip-version-check semgrep

    - name: üîí Semgrep SAST - users-service
      run: |
        cd backend/users-service
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"
        
    - name: üîí Semgrep SAST - academic-service
      run: |
        cd backend/academic-service
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"

    - name: üîí Semgrep SAST - api-gateway
      run: |
        cd backend/api-gateway
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"

    - name: üîí Semgrep SAST - frontend
      run: |
        cd frontend
        semgrep --config=auto --severity=ERROR --error || echo "Semgrep found issues"

    # =========================
    # 7. SAST - SONARQUBE (An√°lisis profundo)
    # =========================
    - name: üîí SonarQube Scan
      continue-on-error: true
      uses: sonarsource/sonarqube-scan-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=juanlabranderoucb_practica2-devsecops
          -Dsonar.projectName="DevSecOps Microservices"
          -Dsonar.organization=juanlabranderoucb

    - name: üîí SonarQube Quality Gate check
      if: always()
      continue-on-error: true
      uses: sonarsource/sonarqube-quality-gate-action@master
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # =========================
    # 8. SCA - AN√ÅLISIS DE DEPENDENCIAS
    # =========================
    - name: üõ°Ô∏è npm audit - users-service
      run: |
        cd backend/users-service
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    - name: üõ°Ô∏è npm audit - academic-service
      run: |
        cd backend/academic-service
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    - name: üõ°Ô∏è npm audit - api-gateway
      run: |
        cd backend/api-gateway
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    - name: üõ°Ô∏è npm audit - frontend
      run: |
        cd frontend
        npm audit --audit-level=high --production || exit 1
      continue-on-error: false

    # =========================
    # 9. CREAR VARIABLES DE ENTORNO
    # =========================
    - name: Create .env files for services
      run: |
        # Backend services
        cp backend/users-service/.env.example backend/users-service/.env
        cp backend/academic-service/.env.example backend/academic-service/.env
        cp backend/api-gateway/.env.example backend/api-gateway/.env
        
        # Frontend
        cp frontend/.env.example frontend/.env
        echo "VITE_API_URL=http://localhost:3000" >> frontend/.env

    # =========================
    # 10. BUILD DE CONTENEDORES
    # =========================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üêã Build Docker image - users-service
      run: |
        docker build \
          -t users-service:latest \
          -t users-service:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./backend/users-service

    - name: üêã Build Docker image - academic-service
      run: |
        docker build \
          -t academic-service:latest \
          -t academic-service:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./backend/academic-service

    - name: üêã Build Docker image - api-gateway
      run: |
        docker build \
          -t api-gateway:latest \
          -t api-gateway:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./backend/api-gateway

    - name: üêã Build Docker image - frontend
      run: |
        docker build \
          -t frontend:latest \
          -t frontend:${{ env.IMAGE_TAG }} \
          --label "git.commit=${{ github.sha }}" \
          --label "git.branch=${{ github.ref_name }}" \
          ./frontend

    # =========================
    # 11. SEGURIDAD DE CONTENEDORES - TRIVY
    # =========================
    - name: üîê Trivy scan - users-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'users-service:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    - name: üîê Trivy scan - academic-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'academic-service:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    - name: üîê Trivy scan - api-gateway
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'api-gateway:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    - name: üîê Trivy scan - frontend
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'frontend:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        ignore-unfixed: true
        trivyignores: '.trivyignore'

    # =========================
    # 12. REPORTE FINAL
    # =========================
    - name: üìä Pipeline Summary
      if: always()
      run: |
        echo "================================"
        echo "üéâ PIPELINE DEVSECOPS COMPLETO"
        echo "================================"
        echo "‚úÖ Instalaci√≥n reproducible"
        echo "‚úÖ An√°lisis de calidad (ESLint)"
        echo "‚úÖ Testing automatizado"
        echo "‚úÖ SAST (Semgrep + SonarQube)"
        echo "‚úÖ SCA (npm audit)"
        echo "‚úÖ Build de contenedores"
        echo "‚úÖ Seguridad contenedores (Trivy)"
        echo "================================"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "================================"